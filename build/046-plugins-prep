#!/bin/bash
if [[ -e /var/log/nems/ ]]; then
  echo $0 > /var/www/html/userfiles/nems-build.cur
fi

# This script cleans up / removes all installed Nagios plugins to prepare for installation/re-installation

  # Ensure apt installed versions don't exist
  apt-get -y remove --purge monitoring-plugins*
  apt-get -y remove --purge nagios-nrpe-plugin
  apt-get -y autoremove

  # Install dependencies
  # Doing one per apt instance to avoid it failing if one package is missing
  apt-get update
  apt-get install -y libnet-snmp-perl
  apt-get install -y snmp
  apt-get install -y snmpd
  apt-get install -y snmp-mibs-downloader
  apt-get install -y dnsutils
  apt-get install -y fping
  apt-get install -y iputils-ping
  apt-get install -y libfreeradius-client-dev
  apt-get install -y libldap2-dev
  apt-get install -y default-libmysqlclient-dev
  apt-get install -y libdbi-dev
  apt-get install -y libdbi-perl
  apt-get install -y smbclient
  apt-get install -y qstat
  apt-get install -y openssl
  apt-get install -y openssl-devel
  apt-get install -y gettext
  apt-get install -y openssl
  apt-get install -y bc
  apt-get install -y dc

# Install PostgreSQL development libraries so
# check_psql (monitoring-plugins) can compile
  apt-get install -y libpq-dev



  # Cleanup residue and then prep folders

    # remove libexec if it is a directory (not symlink)
    if [[ -d /usr/local/nagios/libexec ]]; then
      rm -rf /usr/local/nagios/libexec
    fi

    if [[ -e /usr/lib/nagios/plugins ]]; then
      rm -rf /usr/lib/nagios/plugins
    fi

    # Create the target folder if it doesn't exist
    if [[ ! -d /usr/lib/nagios ]]; then
      mkdir -p /usr/lib/nagios/plugins
    fi

    # If the libexec symlink doesn't already exist, create it
    if [[ ! -e /usr/local/nagios/libexec ]]; then
      ln -s /usr/lib/nagios/plugins /usr/local/nagios/libexec
    fi


# Setup the environment to make compatible with non-NEMS systems
if [[ ! -e /usr/lib/nagios/plugins/ ]]; then
  mkdir -p /usr/lib/nagios/plugins/
fi
if [[ ! -e /usr/local/nagios/etc/ ]]; then
  mkdir -p /usr/local/nagios/etc/
fi

# "Fix" Ubuntu and the fact that NRPE's install-init uses /usr/lib/systemd/system instead of /etc/systemd/system
if [[ ! -e /usr/lib/systemd/system/ ]]; then
  if [[ -e /etc/systemd/system/ ]]; then
    ln -s /etc/systemd/system /usr/lib/systemd/system
  fi
fi

