#!/bin/bash
# https://raymii.org/s/tutorials/Nagios_Core_4_Installation_on_Ubuntu_12.04.html
# https://ahmermansoor.blogspot.com/2016/09/install-configure-nagiosgraph-on-nagios.html
# https://www.allcloud.io/how-to/install-nagiosgraph/
# Access at /nagiosgraph/cgi-bin/show.cgi

# Install dependencies
apt -y install libgd-graph-perl
apt -y install libnagios-object-perl

if [[ -d /usr/local/src/nagiosgraph ]]; then
  rm -Rf /tmp/nagiosgraph/
fi
mkdir -p /tmp/nagiosgraph/
cd /tmp/nagiosgraph/
wget http://downloads.sourceforge.net/project/nagiosgraph/nagiosgraph/1.5.2/nagiosgraph-1.5.2.tar.gz
tar -xf nagiosgraph-1.5.2.tar.gz
cd nagiosgraph-1.5.2

if [[ -d /usr/local/nagios/nagiosgraph ]]; then
  rm -rf /usr/local/nagios/nagiosgraph
fi
mkdir /usr/local/nagios/nagiosgraph
cp -r etc /usr/local/nagios/nagiosgraph/

sed -i "s#/opt/nagiosgraph/etc#/usr/local/nagios/nagiosgraph/etc#g" cgi/*cgi 
cp cgi/*.cgi /usr/local/nagios/sbin

sed -i "s#/opt/nagiosgraph/etc#/usr/local/nagios/nagiosgraph/etc#g" lib/insert.pl
cp lib/insert.pl /usr/local/nagios/libexec

cp share/nagiosgraph.css /usr/local/nagios/share
cp share/nagiosgraph.js /usr/local/nagios/share

cp -f /root/nems/nems-migrator/data/1.5/nagios/misc/nagiosgraph.conf /usr/local/nagios/nagiosgraph/etc/

mkdir /usr/local/nagios/nagiosgraph/var
mkdir /usr/local/nagios/nagiosgraph/var/rrd

echo '<script type="text/javascript" src="/nagios/nagiosgraph.js"></script>' > /usr/local/nagios/share/ssi/common-header.ssi

cp /root/nems/nems-migrator/data/1.5/nagios/etc/nagios.cfg /usr/local/nagios/etc/

chown -R nagios:nagios /usr/local/nagios/
chmod 755 /usr/local/nagios/nagiosgraph/var/rrd
touch /usr/local/nagios/nagiosgraph/var/nagiosgraph.log
chmod 664 /usr/local/nagios/nagiosgraph/var/nagiosgraph.log
touch /usr/local/nagios/nagiosgraph/var/nagiosgraph-cgi.log
chown www-data /usr/local/nagios/nagiosgraph/var/nagiosgraph-cgi.log
chmod 664 /usr/local/nagios/nagiosgraph/var/nagiosgraph-cgi.log

cp -f share/graph.gif /usr/local/nagios/share/images/action.gif

# Cleanup backups of CSS files
rm /var/www/html/share/nagios_themes/nems-1.3/nagiosgraph.css.*

echo '# enable nagiosgraph CGI scripts
ScriptAlias /nagiosgraph/cgi-bin "/usr/local/nagiosgraph/cgi"
<Directory "/usr/local/nagiosgraph/cgi">
   Options ExecCGI
   AllowOverride None
   Require all granted
   AuthName "NEMS User"
   AuthType Basic
   AuthUserFile /var/www/htpasswd
   Require valid-user
</Directory>
# enable nagiosgraph CSS and JavaScript
Alias /nagiosgraph "/usr/local/nagiosgraph/share"
<Directory "/usr/local/nagiosgraph/share">
   Options None
   AllowOverride None
   Require all granted
</Directory>
' > /etc/apache2/conf-available/nagiosgraph.conf

a2enconf nagiosgraph

systemctl restart nagios
systemctl restart apache2

