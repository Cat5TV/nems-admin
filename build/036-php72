#!/bin/bash

# Get the platform before removing php (as it requires PHP)
platform=$(/usr/local/bin/nems-info platform)

# Uninstall PHP 7.0 residual packages
apt remove --purge -y php7.0-cli
apt remove --purge -y php7.0-common
apt remove --purge -y php7.0-json
apt remove --purge -y php7.0-opcache
apt remove --purge -y php7.0-phpdbg
apt remove --purge -y php7.0-readline
apt -y autoremove

# Install PHP 7.2

# Use Raspbian repo for Pi, Sury's Debian Repo for others.
if [[ $platform = "0" ]] ||
   [[ $platform = "1" ]] ||
   [[ $platform = "2" ]] ||
   [[ $platform = "3" ]] ||
   [[ $platform = "4" ]] ||
   [[ $platform = "5" ]] ||
   [[ $platform = "6" ]] ||
   [[ $platform = "7" ]] ||
   [[ $platform = "8" ]] ||
   [[ $platform = "9" ]]; then
  echo "deb http://mirrordirector.raspbian.org/raspbian/ buster main contrib non-free rpi" > /etc/apt/sources.list.d/10-buster.list
  echo "Package: *
Pin: release n=stretch
Pin-Priority: 900

Package: *
Pin: release n=buster
Pin-Priority: 750" > /etc/apt/preferences.d/10-buster
else
  # Use Sury's Debian repository (will break Raspberry Pi Zero/1)
  echo "Setting up new repository..."
  wget -q https://packages.sury.org/php/apt.gpg -O- | sudo apt-key add -
  echo "deb https://packages.sury.org/php/ $(lsb_release -sc) main" | tee /etc/apt/sources.list.d/php.list
fi

# Now, upgrade
apt update
apt -y upgrade

echo "Installing PHP 7.2..."
# Install PHP 7.2
apt install -y php7.2
apt install -y php7.2-cli
apt install -y php7.2-common
apt install -y php7.2-curl
apt install -y php7.2-gd
apt install -y php7.2-json
apt install -y php7.2-mbstring
apt install -y php7.2-mysql
apt install -y php7.2-opcache
apt install -y php7.2-phpdbg
apt install -y php7.2-readline
apt install -y php7.2-sqlite3
apt install -y php7.2-xml
apt install -y libapache2-mod-php7.2
apt install -y libargon2-1
apt install -y libsodium23
apt install -y php-curl
apt install -y php-rrd
echo "Done."

systemctl restart apache2
