#!/bin/bash
echo $0 > /var/www/html/userfiles/nems-build.cur

# Add and configure NEMS packages

# System

  if [[ ! -d /var/log/nems ]]; then
    mkdir /var/log/nems
  fi

# Disable swap - we'll be using ZRAM
  sed -i '/ swap / s/^/#/' /etc/fstab
  swapoff -a

cd /root/nems # this was created with nems-prep.sh

if [[ ! -d nems-migrator ]]; then
  git clone https://github.com/Cat5TV/nems-migrator
fi

if [[ ! -d nagios-api ]]; then
  git clone https://github.com/zorkian/nagios-api
  cd nagios-api
  apt update
  python3 -m pip install -U pip setuptools
  apt install -y libffi-dev
  pip3 install wheel
  pip3 install -r requirements.txt
fi

# Import NEMS crontab (must happen after nems-migrator but before fixes.sh)
crontab /root/nems/nems-migrator/data/nems/crontab

# Create symlinks, apply patches/fixes, etc.
/usr/local/share/nems/nems-scripts/fixes.sh

# Point Nagios to the NEMS Nagios Theme in nems-www and import the config
if [[ -d /usr/local/nagios/share ]]; then
  rm -rf /usr/local/nagios/share
fi
ln -s /var/www/html/share/nagios/ /usr/local/nagios/share

# Our Apache conf requires htpasswd exist in order to load.
# Prevent misleading errors before nems-init by creating an empty file.
if [[ ! -e /var/www/htpasswd ]]; then
  touch /var/www/htpasswd
  chown www-data:www-data /var/www/htpasswd
fi

# Generate certificates
nems-cert

# Restart related services
/bin/systemctl restart apache2
/bin/systemctl restart nagios


# Install 9590
# A simple listener on Port 9590 for documentation examples
cp /root/nems/nems-migrator/data/1.4/init.d/9590 /etc/init.d/
/usr/sbin/update-rc.d 9590 defaults
/usr/sbin/update-rc.d 9590 enable
/etc/init.d/9590 start

