#!/bin/bash

# Set the version (see git releases)
nrpeVer="3.2.1"
#nrpeVer="4.0.0"

tmpdir=`mktemp -d -p /usr/src/`
cd $tmpdir

if [[ ! -e /usr/lib/nagios/plugins/ ]]; then
  mkdir -p /usr/lib/nagios/plugins
fi

# Determine if this is NEMS or not.
if [[ -e /var/log/nems/ ]]; then
  isnems=1
  # Run the prep script before continuing to remove the previous installation
  /root/nems/nems-admin/build/046-plugins-prep
else
  isnems=0
  # Run the prep script before continuing since this is not NEMS Linux
  wget -O - https://raw.githubusercontent.com/Cat5TV/nems-admin/master/build/046-plugins-prep | bash
fi

APT_LISTCHANGES_FRONTEND=cat
echo $0 > /var/www/html/userfiles/nems-build.cur
/bin/systemctl stop nrpe
# these plugins shouldn't even exist anymore since they were pulled from packages.add and 045-nagios
apt-get remove -y --purge nagios-nrpe-plugin
apt-get remove -y --purge nagios-nrpe-server
apt-get -y autoremove
apt-get update

apt-get install -y libssl-dev
apt-get install -y dpatch
apt-get install -y debhelper
apt-get install -y libwrap0-dev
apt-get install -y autotools-dev
apt-get install -y build-essential

file="https://github.com/NagiosEnterprises/nrpe/archive/nrpe-$nrpeVer.tar.gz"
wget -O $tmpdir/nrpe.tar.gz $file
tar xvzf nrpe.tar.gz
cd nrpe-*
./configure --enable-command-args
make all
make install-groups-users
make install-plugin
make install-daemon
make install-config
#make install-init
/usr/bin/install -c -m 644 startup/default-service /lib/systemd/system/nrpe.service

/bin/systemctl stop nrpe

wget -O /usr/local/nagios/etc/nrpe.cfg https://raw.githubusercontent.com/Cat5TV/nems-migrator/master/data/1.6/nagios/misc/nrpe.cfg

systemctl daemon-reload

/bin/systemctl start nrpe
/bin/systemctl enable nrpe
/bin/systemctl status nrpe --no-pager

if [[ $isnems == 1 ]]; then
  if ! grep -q "PATCH-000007" /var/log/nems/patches.log; then
    echo "PATCH-000007" >> /var/log/nems/patches.log
  fi
  /root/nems/nems-admin/build/051-monitoring-plugins
  /root/nems/nems-admin/build/052-nems-nagios-plugins
else
  wget -O - https://raw.githubusercontent.com/Cat5TV/nems-admin/master/build/051-monitoring-plugins | bash
  wget -O - https://raw.githubusercontent.com/Cat5TV/nems-admin/master/build/052-nems-nagios-plugins | bash
fi

# Remove the tmp files
cd /tmp
rm -rf $tmpdir

# so error code on failure doesn't fail run-parts
echo "Done."
