#!/bin/bash
echo $0 > /var/www/html/index.html

  # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
  # This script is run during initial NEMS compile, but because sometimes   #
  # bugs are fixed in nagios-plugins that could affect users, you can also  #
  # run this at any time to reinstall all plugins.                          #
  # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #

  # Install dependencies
  # Doing one per apt instance to avoid it failing if one package is missing
  apt update
  apt install -y libnet-snmp-perl
  apt install -y snmp
  apt install -y snmpd
  apt install -y snmp-mibs-downloader
  apt install -y dnsutils
  apt install -y fping
  apt install -y iputils-ping
  apt install -y libfreeradius-client-dev
  apt install -y libldap2-dev
  apt install -y default-libmysqlclient-dev
  apt install -y libdbi-dev
  apt install -y libdbi-perl
  apt install -y smbclient
  apt install -y qstat
  apt install -y openssl
  apt install -y openssl-devel

  # BEGIN Fix NRPE and check_wmi_plus

    # Remove NRPE plugin if it is installed in the wrong folder
    # Check if it's a directory (not symlink) first
    if [[ -d /usr/lib/nagios/plugins ]]; then
      if [[ -e /usr/lib/nagios/plugins/check_nrpe ]]; then
        apt -y --purge remove nagios-nrpe-plugin
      fi
    fi

    # If the plugins folder still exists, rename it (would rather delete)
    if [[ -d /usr/lib/nagios/plugins ]]; then
      mv /usr/lib/nagios/plugins /usr/lib/nagios/plugins~
    fi

    # Create the base folder if it doesn't exist
    if [[ ! -d /usr/lib/nagios ]]; then
      mkdir /usr/lib/nagios
    fi

    # If the plugins symlink doesn't already exist, create it
    # This is needed for check_wmi_plus. While I could patch it, I don't want to have to maintain it TBH
    if [[ ! -e /usr/lib/nagios/plugins ]]; then
      ln -s /usr/local/nagios/libexec /usr/lib/nagios/plugins
    fi

    # Reinstall check_nrpe, which will now pop into the correct folder due to the symlink
    apt install -y nagios-nrpe-plugin

  # END Fix NRPE and check_wmi_plus

  # Setup automake so this can compile on any system.
  # for example, in early builds for PINE64 you'd have to do this:  ./configure --build=arm --with-nagios-user=nagios --with-nagios-group=nagios
  # but now automake allows automatic detection of platform
    apt -y install automake
    automake=$(ls -r /usr/share/automake*/config.guess | head -1)

  # Obtain the source for nagios-plugins
    # Set version to download and deploy
    npver="2.2.1"

    if [[ -d /tmp/nagios-plugins-$npver/ ]]; then
      rm -rf /tmp/nagios-plugins-$npver/
    fi
    wget -O /tmp/nagios-plugins.tar.gz https://nagios-plugins.org/download/nagios-plugins-$npver.tar.gz
    cd /tmp/
    tar -zxvf /tmp/nagios-plugins.tar.gz
    cd /tmp/nagios-plugins-$npver/
    # This is where automake's config gets written to the nagios-plugins src:
    cp $automake /tmp/nagios-plugins-$npver/build-aux/
    # Build it and install it
      ./configure --with-nagios-user=nagios --with-nagios-group=nagios --with-openssl
      make
      make install

    # Timeticks issue in 2.2.1 reported by Tech Dave: https://forum.category5.tv/thread-197-post-1549.html#pid1549
    # Therefore, downgrade check_snmp to 2.1.1 while leaving everything else at 2.2.1
    # Unfortunately the tradeoff is that 2.1.1 doesn't work with ipv6. Can't wait for 2.2.2!
    if [[ $npver = '2.2.1' ]]; then
      npver="2.1.1"

      if [[ -d /tmp/nagios-plugins-$npver/ ]]; then
        rm -rf /tmp/nagios-plugins-$npver/
      fi
      wget -O /tmp/nagios-plugins.tar.gz https://nagios-plugins.org/download/nagios-plugins-$npver.tar.gz
      cd /tmp/
      tar -zxvf /tmp/nagios-plugins.tar.gz
      cd /tmp/nagios-plugins-$npver/
      # This is where automake's config gets written to the nagios-plugins src:
      cp $automake /tmp/nagios-plugins-$npver/build-aux/
      # Build it and install it
        ./configure --with-nagios-user=nagios --with-nagios-group=nagios --with-openssl
        make
        # do not make install it since we ONLY want check_snmp... instead:
        cp -f plugins/check_snmp /usr/local/nagios/libexec/
    fi

