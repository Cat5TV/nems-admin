#!/bin/bash
# Thanks to Ryan Siegel for the contribution on NEMS 1.2.1

apt install -y autoconf cpanminus libclass-std-storable-perl
cpanm DateTime::TimeZone
cpanm DateTime::Locale
cpanm Getopt::Long
cpanm Number::Format
cpanm Scalar::Util
cpanm Data::Dumper
cpanm Config::IniFiles
#cpanm Storable

cd /tmp/

# Install WMI
wget -O wmi.tar.bz2 http://www.openvas.org/download/wmi/wmi-1.3.14.tar.bz2
bzip2 -cd wmi.tar.bz2 | tar xf -
cd wmi-1.3.14/
# Remove line 583 to make compatible with Perl > 5.22
sed -i~ '/defined @$pidl/d' Samba/source/pidl/pidl
# WMI's build script has a leak... but rather than fixing it we will temporarily bypass it
# This setting does not survive reboot, so no worries (as long as it doesn't crash your system)
ulimit -n 10000
# Build
make "CPP=gcc -E -ffreestanding"
cp Samba/source/bin/wmic /usr/local/bin

# Install WMI Plus
wget -O wmi_plus.tar.gz http://edcint.co.nz/checkwmiplus/sites/default/files/check_wmi_plus.v1.63.tar.gz
mkdir wmi_plus
cd wmi_plus
tar xzf ../wmi_plus.tar.gz
mv check_wmi_plus.pl /usr/local/nagios/libexec
mv etc/check_wmi_plus /etc/

# Install the NEMS 1.4+ conf file for check_wmi_plus
cp -f /root/nems/nems-migrator/data/1.4/nagios/plugins/check_wmi_plus.conf /etc/check_wmi_plus/
