#!/bin/bash
echo $0 > /tmp/nems-build.cur
# Thanks to Ryan Siegel for the contribution on NEMS 1.2.1
# Updated for NEMS 1.5 since openvas stopped distributing the package

apt install -y autoconf cpanminus libclass-std-storable-perl cmake gnutls-dev heimdal-dev libpopt-dev libglib2.0-dev gcc-mingw-w64 gcc pkg-config perl-base

cpanm DateTime::TimeZone
cpanm DateTime::Locale
cpanm Getopt::Long
cpanm Number::Format
cpanm Scalar::Util
cpanm Data::Dumper
cpanm Config::IniFiles
#cpanm Storable

cd /tmp/

# Install WMI
if [[ -d /tmp/nems-wmic ]]; then
  rm -rf /tmp/nems-wmic
fi
git clone https://github.com/Cat5TV/nems-wmic

if [[ -d /tmp/nems-wmic/build ]]; then
  rm -rf /tmp/nems-wmic/build
fi
# as set in GNUmakefile
mkdir /tmp/nems-wmic/build
cd /tmp/nems-wmic/build

# Build
cmake ..
make

# Install
make install

# Reload configs from /etc/ld.so.conf.d which includes the libc.conf
# which tells environment to find libraries in /usr/local/lib/
# else /usr/local/lib/libopenvas_wmiclient.so.1 will not be found by wmic
/sbin/ldconfig

# Stop here if not running NEMS Linux
# (for those who want to use this installer on other distros)
if [[ ! -e /usr/local/bin/nems-info ]]; then
  exit
fi

# Install WMI Plus
# NEMS 1.5 moves this to our repo. Download new versions at http://edcint.co.nz/checkwmiplus
## wget -O wmi_plus.tar.gz http://edcint.co.nz/checkwmiplus/sites/default/files/check_wmi_plus.v1.64.tar.gz
cd /tmp/nems-wmic/extras/check_wmi_plus
cp -f check_wmi_plus.pl /usr/local/nagios/libexec
cp -rf etc/check_wmi_plus /etc/

# Install the NEMS conf file for check_wmi_plus
cp -f /root/nems/nems-migrator/data/1.5/nagios/misc/check_wmi_plus.conf /etc/check_wmi_plus/

# Clean up
rm -rf /tmp/nems-wmic/
