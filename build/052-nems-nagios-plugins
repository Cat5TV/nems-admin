#!/bin/bash

  # Dependencies
    # CISCO
    apt -y install libnet-snmp-perl snmp
    # WMIC
    apt -y install libdatetime-timezone-perl
    # check_ipmi_sensor
    apt -y install libipc-run-perl freeipmi

  # Setup an interpreter for notify-by-pushover (and possibly others... prevents problems)
  if [[ ! -f /usr/local/bin/php ]]; then
    if [[ -f /usr/bin/php ]]; then
      ln -s /usr/bin/php /usr/local/bin/php
    fi
  fi

  # Grab the Migrator plugins
    cp -f /root/nems/nems-migrator/data/1.5/nagios/plugins/* /usr/local/nagios/libexec/

  # Add backward compatibility for notify-by-telegram (in case user has NEMS 1.3-1.4 config)
    if [[ -f /usr/local/bin/telegram_nems.lua ]]; then
      rm -f /usr/local/bin/telegram_nems.lua
    fi
    ln -s /usr/local/nagios/libexec/notify-by-telegram.lua /usr/local/bin/telegram_nems.lua


  # Add IPMI sudoers access for nagios user
  if ! grep -q "# IPMI" /etc/sudoers; then
    echo "# IPMI" >> /etc/sudoers
    echo "nagios ALL=(root) NOPASSWD: /usr/sbin/ipmi-sensors, /usr/sbin/ipmi-sel" >> /etc/sudoers
  fi



