#!/bin/bash
echo $0 > /var/www/html/userfiles/nems-build.cur

  # Dependencies
    # CISCO
    apt -y install libnet-snmp-perl snmp
    # WMIC
    apt -y install libdatetime-timezone-perl
    apt -y install libdatetime-perl

    # check_ipmi_sensor
    apt -y install libipc-run-perl
    apt -y install freeipmi

    # check_esxi_hardware
    apt install -y python-pywbem

  # Setup an interpreter for notify-by-pushover (and possibly others... prevents problems)
  if [[ ! -f /usr/local/bin/php ]]; then
    if [[ -f /usr/bin/php ]]; then
      ln -s /usr/bin/php /usr/local/bin/php
    fi
  fi

  # Grab the Migrator plugins
    cp -f /root/nems/nems-migrator/data/1.5/nagios/plugins/* /usr/lib/nagios/plugins/

  # Log patch of upgrade to speedtest
    if ! grep -q "PATCH-000004" /var/log/nems/patches.log; then
      echo "PATCH-000004" >> /var/log/nems/patches.log
    fi

  # Add backward compatibility for notify-by-telegram (in case user has NEMS 1.3-1.4 config)
    if [[ -f /usr/local/bin/telegram_nems.lua ]]; then
      rm -f /usr/local/bin/telegram_nems.lua
    fi
    ln -s /usr/lib/nagios/plugins/notify-by-telegram.lua /usr/local/bin/telegram_nems.lua


  # Add IPMI sudoers access for nagios user
  if ! grep -q "# IPMI" /etc/sudoers; then
    echo "# IPMI" >> /etc/sudoers
    echo "nagios ALL=(root) NOPASSWD: /usr/sbin/ipmi-sensors, /usr/sbin/ipmi-sel" >> /etc/sudoers
  fi



