#!/bin/bash
if [[ -e /var/log/nems/ ]]; then
  echo $0 > /var/www/html/userfiles/nems-build.cur
fi

# Detect whether this is DEB- or RPM-based system
if [[ -f /etc/debian_version ]]; then
  pm=deb
fi
if [[ $(grep -Ei 'debian|buntu|mint' /etc/*release) ]]; then
  pm=deb
fi
if [[ $(grep -Ei 'fedora|redhat' /etc/*release) ]]; then
  pm=rpm
fi
if [[ $pm == 'deb' ]]; then
  echo "Detected DEB package manager..."
  APT_LISTCHANGES_FRONTEND=cat
  pm_cleanup="apt-get -y autoremove"
  pm_update="apt-get update"
  pm_purge="apt-get remove -y --purge"
  pm_install="apt-get install -y"
elif [[ $pm == 'rpm' ]]; then
  echo "Detected RPM package manager..."
  pm_cleanup=""
  pm_update=""
  pm_purge="yum erase -y"
  pm_install="yum install -y"
else
  echo "Failed to determine your distro's package manager. Please notify us of this issue."
  exit
fi

  # Dependencies

    # Perl
    $pm_install perl
    $pm_install perl_base
    $pm_install perl-base
    yes | perl -MCPAN -e 'install Math::Round'

    # CISCO
    $pm_install libnet-snmp-perl snmp

    # WMIC
    $pm_install libdatetime-timezone-perl
    $pm_install libdatetime-perl

    # check_ipmi_sensor
    $pm_install libipc-run-perl
    $pm_install freeipmi

    # check_esxi_hardware
    $pm_install python-pywbem

    # Commands required for custom_check_mem
    $pm_install gawk
    $pm_install bc
    $pm_install dc

    # check_apc
    yes | perl -MCPAN -e 'install Switch'

    # check_mikrotik_switch
    yes | perl -MCPAN -e 'install Set::IntSpan'

  # Setup an interpreter for notify-by-pushover (and possibly others... prevents problems)
  if [[ ! -f /usr/local/bin/php ]]; then
    if [[ -f /usr/bin/php ]]; then
      ln -s /usr/bin/php /usr/local/bin/php
    fi
  fi

  if [[ -e /var/log/nems/ ]]; then # NEMS
    # Grab the Migrator plugins
    cp -f /root/nems/nems-migrator/data/1.6/nagios/plugins/* /usr/lib/nagios/plugins/

    # Log patch of upgrade to speedtest
    if ! grep -q "PATCH-000004" /var/log/nems/patches.log; then
      echo "PATCH-000004" >> /var/log/nems/patches.log
    fi
  else # Not NEMS
    tmpdir=`mktemp -d -p /usr/src/`
    cd $tmpdir
    $pm_install git
    git clone https://github.com/cat5tv/nems-migrator
    # Grab the Migrator plugins
    cp -f $tmpdir/nems-migrator/data/1.6/nagios/plugins/* /usr/lib/nagios/plugins/
    rm -rf $tmpdir
  fi

  # Add backward compatibility for notify-by-telegram (in case user has NEMS 1.3-1.4 config)
    if [[ -f /usr/local/bin/telegram_nems.lua ]]; then
      rm -f /usr/local/bin/telegram_nems.lua
    fi
    ln -s /usr/lib/nagios/plugins/notify-by-telegram.lua /usr/local/bin/telegram_nems.lua


  # Add IPMI sudoers access for nagios user
  if ! grep -q "# IPMI" /etc/sudoers; then
    echo "# IPMI" >> /etc/sudoers
    echo "nagios ALL=(root) NOPASSWD: /usr/sbin/ipmi-sensors, /usr/sbin/ipmi-sel" >> /etc/sudoers
  fi


# WMI Checks for Microsoft Windows hosts

# Thanks to Ryan Siegel for the original contribution in NEMS Linux 1.2.1.
# Updated for NEMS Linux 1.5 since openvas stopped distributing the package.

# Updated for NEMS Linux 1.6: Entirely deprecated the old (unsupported) wmic
# application and moved to a Python-based alternative (drop-in replacement)
# in the NEMS Linux repository.

printf "Installing check_wmi_plus... "
# Remove previous install of check_wmi_plus
if [[ -e /etc/check_wmi_plus/ ]]; then
  rm -rf /etc/check_wmi_plus/
fi
# Install check_wmi_plus
cp -f /root/nems/nems-migrator/data/1.6/nagios/plugins/check_wmi_plus.pl /usr/lib/nagios/plugins/

# Copy the configs
cp -rf /root/nems/nems-migrator/data/1.6/check_wmi_plus /etc/

# Create the ini dir (which is designated in the conf below)
if [[ ! -e /etc/check_wmi_plus/check_wmi_plus.d ]]; then
  mkdir /etc/check_wmi_plus/check_wmi_plus.d
fi

# Set ownership
chown -R nagios:nagios /etc/check_wmi_plus/

# End WMI Checks for Microsoft Windows hosts
