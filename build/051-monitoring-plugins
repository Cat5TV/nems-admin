#!/bin/bash
echo $0 > /var/www/html/userfiles/nems-build.cur

  # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
  # This script is run during initial NEMS compile, but because sometimes   #
  # bugs are fixed in nagios-plugins that could affect users, you can also  #
  # run this at any time to reinstall all plugins.                          #
  # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #

  # Remove old apt installed version
  apt -y remove --purge monitoring-plugins

  # Install dependencies
  # Doing one per apt instance to avoid it failing if one package is missing
  apt update
  apt install -y libnet-snmp-perl
  apt install -y snmp
  apt install -y snmpd
  apt install -y snmp-mibs-downloader
  apt install -y dnsutils
  apt install -y fping
  apt install -y iputils-ping
  apt install -y libfreeradius-client-dev
  apt install -y libldap2-dev
  apt install -y default-libmysqlclient-dev
  apt install -y libdbi-dev
  apt install -y libdbi-perl
  apt install -y smbclient
  apt install -y qstat
  apt install -y openssl
  apt install -y openssl-devel

  apt install -y gettext

  # BEGIN Fix NRPE and check_wmi_plus
    apt -y remove --purge nagios-nrpe-plugin

    apt -y autoremove

    # remove libexec if it is a directory (not symlink)
    if [[ -d /usr/local/nagios/libexec ]]; then
      rm -rf /usr/local/nagios/libexec
    fi

    if [[ -e /usr/lib/nagios/plugins ]]; then
      rm -rf /usr/lib/nagios/plugins
    fi

    # Create the target folder if it doesn't exist
    if [[ ! -d /usr/lib/nagios ]]; then
      mkdir -p /usr/lib/nagios/plugins
    fi

    # If the libexec symlink doesn't already exist, create it
    if [[ ! -e /usr/local/nagios/libexec ]]; then
      ln -s /usr/lib/nagios/plugins /usr/local/nagios/libexec
    fi

    # Reinstall check_nrpe, which will now pop into the correct folder due to the symlink
    if [[ ! -e /usr/lib/nagios/plugins/check_nrpe ]]; then
      apt install -y nagios-nrpe-plugin
    fi

  # END Fix NRPE and check_wmi_plus

  # Install the plugins
    cd /tmp
    if [[ -e monitoring-plugins ]]; then
      rm -rf monitoring-plugins
    fi
    git clone https://github.com/Cat5TV/monitoring-plugins
    cd monitoring-plugins
    ./tools/setup
    ./configure --prefix=/usr/local/nagios/ --with-cgiurl=/nagios/cgi-bin
    make
    make install
