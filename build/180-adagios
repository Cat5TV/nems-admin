#!/bin/bash
echo $0 > /var/www/html/userfiles/nems-build.cur

# Add var folder if didn't get created in 050
if [[ ! -e /var/lib/nagios/ ]]; then
  mkdir /var/lib/nagios/
  chown -R nagios:nagios /var/lib/nagios/
fi

# Prepare sudo permissions
if ! grep -q "# Adagios" /etc/sudoers; then
echo '
# Adagios
Defaults:%nagios !requiretty
%nagios             ALL = NOPASSWD: /etc/init.d/nagios *
%nagios             ALL = NOPASSWD: /bin/systemctl *
%nagios             ALL = NOPASSWD: /usr/local/nagios/bin/nagios -v *
' | sudo EDITOR='tee -a' visudo
fi

if ! grep -q "# Adagios 1.5" /etc/sudoers; then
echo '
# Adagios 1.5
Defaults:www-data    !requiretty
www-data ALL = (root) NOPASSWD: /usr/sbin/service nagios *
www-data ALL = (root) NOPASSWD: /usr/local/nagios/bin/nagios -v *
' | sudo EDITOR='tee -a' visudo
fi

# Install dependencies
apt install -y libapache2-mod-wsgi python-simplejson libgmp-dev python-dev python-paramiko

# Install Django
python -m pip install --upgrade pip setuptools
pip install django==1.6
pip install django-clear-cache

# Install Pynag
cd /tmp
git clone git://github.com/pynag/pynag.git 
cd pynag
python setup.py build
python setup.py install

# Install Adagios
cd /tmp/
wget -O adagios.tar.gz https://github.com/opinkerfi/adagios/archive/adagios-1.6.3-2.tar.gz
tar xzf adagios.tar.gz
cd adagios-adagios-1.6.3-2
if [[ -d /etc/adagios ]]; then
  rm -rf /etc/adagios
fi
if [[ -d /usr/local/lib/python2.7/dist-packages/adagios ]]; then
  rm -rf /usr/local/lib/python2.7/dist-packages/adagios
fi
cp -R adagios/etc/adagios /etc/
cp -f /root/nems/nems-migrator/data/1.5/adagios/adagios.conf /etc/adagios/
python setup.py install
ln -s /usr/local/lib/python2.7/dist-packages/adagios /var/www/adagios
chown -R nagios:nagios /etc/adagios
rm -fr /var/www/adagios/etc/
mkdir -p /var/lib/adagios/userdata
chown -R www-data:www-data /var/lib/adagios
cp -f /root/nems/nems-migrator/data/1.5/adagios/settings.py /var/www/adagios/
chown -R www-data:www-data /var/www/adagios/

# Import templates
cp -f /root/nems/nems-migrator/data/1.5/adagios/templates/403.html /var/www/adagios/templates/
cp -f /root/nems/nems-migrator/data/1.5/adagios/templates/base.html /var/www/adagios/templates/


cat << EOF > /etc/apache2/conf-available/adagios.conf
WSGISocketPrefix /var/run/apache2/wsgi
WSGIDaemonProcess adagios user=nagios group=nagios processes=1 threads=25 python-path=/var/www/adagios
WSGIProcessGroup adagios
WSGIScriptAlias /adagios /var/www/adagios/apache/adagios.wsgi
 
Alias /adagios/media /var/www/adagios/media
 
<Location /adagios>
   AuthName "Adagios Access"
   AuthType Basic
   AuthUserFile /var/www/htpasswd
   Require valid-user
</Location>
EOF

a2dismod python
a2enmod wsgi
a2enconf adagios

# Install okconfig
cd /opt
git clone https://github.com/opinkerfi/okconfig.git
echo 'export PYTHONPATH=$PYTHONPATH:/opt/okconfig' > /etc/profile.d/okconfig.sh
cp -f /root/nems/nems-migrator/data/1.5/adagios/okconfig.conf /etc/okconfig.conf
source /etc/profile
ln -s /opt/okconfig/usr/share/okconfig /usr/share/
ln -s /opt/okconfig/usr/bin/okconfig /usr/local/bin/
okconfig init
okconfig verify

/bin/systemctl restart apache2

# Don't exit when systemctl fails to restart apache2
echo "Done."
